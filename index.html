<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tramvaje do centra</title>
    <style>
        /* Základní styly pro maximální kompatibilitu */
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            color: #000;
            margin: 0;
            padding: 8px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding-bottom: 10px;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 5px 0;
        }
        #stop-name, #last-refreshed {
            font-size: 14px;
            margin: 2px 0;
        }
        .refresh-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            background-color: #007bff;
            color: #fff;
            text-decoration: none;
            border: 1px solid #0056b3;
            border-radius: 4px;
        }
        .tram-card {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 8px;
            margin-bottom: 8px;
        }
        .card-top {
            display: table;
            width: 100%;
            margin-bottom: 5px;
        }
        .line-box, .destination, .time {
            display: table-cell;
            vertical-align: middle;
        }
        .line-box {
            width: 40px;
        }
        .destination {
            padding-left: 8px;
            font-size: 16px;
            font-weight: bold;
        }
        .time {
            width: 50px;
            text-align: right;
            font-size: 18px;
            font-weight: bold;
        }
        .line-number {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            width: 36px;
            height: 28px;
            text-align: center;
            line-height: 28px; /* Vertikální zarovnání textu */
            border-radius: 4px;
            display: block;
        }
        .card-bottom {
            border-top: 1px solid #eee;
            padding-top: 5px;
            font-size: 12px;
            color: #555;
        }
        .delay { float: left; }
        .platform { float: right; }
        .clear { clear: both; } /* Pro vyčištění floatů */

        #loading-indicator, #error-message {
            text-align: center;
            padding: 15px;
            font-size: 14px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Tramvaje do centra</h1>
            <p id="stop-name">Načítání...</p>
            <p id="last-refreshed"></p>
        </div>

        <a href="javascript:location.reload();" class="refresh-button">Aktualizovat odjezdy</a>

        <div id="loading-indicator">
            <p>Načítám nejnovější odjezdy...</p>
        </div>
        
        <div id="error-message" class="hidden">
            <strong style="color: #d00;">Chyba:</strong>
            <span id="error-text">Nepodařilo se načíst data.</span>
        </div>

        <div id="departures-container">
            <!-- Data odjezdů budou vložena zde -->
        </div>
        
        <div style="text-align: center; font-size: 10px; margin-top: 15px;">
            <p>Využívá data PID OpenData (Golemio).</p>
        </div>
    </div>

    <script type="text/javascript">
        // Všechny proměnné definujeme na začátku
        var departuresContainer = document.getElementById('departures-container');
        var loadingIndicator = document.getElementById('loading-indicator');
        var errorMessage = document.getElementById('error-message');
        var errorText = document.getElementById('error-text');
        var stopNameElement = document.getElementById('stop-name');
        var lastRefreshedElement = document.getElementById('last-refreshed');

        // Konfigurace pro zastávku
        var STOP_ID = "U266Z1P"; // GTFS ID pro "Kněžská luka"
        var API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MzcxMiwiaWF0IjoxNzUwNTAwOTIxLCJleHAiOjExNzUwNTAwOTIxLCJpc3MiOiJnb2xlbWlvIiwianRpIjoiNGE2MjY3NjYtZjYxOC00MjJhLTkwYTQtMzAyNmQ5ODZiMmY0In0.-aVvSoLgKJr5xv6VdVDW5dPFcJWiMP0TPEi344UJhdE";
        var API_URL = 'https://api.golemio.cz/v2/pid/departureboards?ids=' + STOP_ID + '&minutesAfter=120';

        // Funkce pro načtení dat pomocí XMLHttpRequest pro maximální kompatibilitu
        function fetchTramDepartures() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) { // Požadavek dokončen
                    loadingIndicator.className = 'hidden'; // Skrýt indikátor načítání
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            displayDepartures(data);
                        } catch (e) {
                            showError("Chyba při zpracování dat.");
                            console.error("JSON Parse Error:", e);
                        }
                    } else {
                        showError("Chyba při komunikaci se serverem (HTTP " + xhr.status + ").");
                        console.error("XHR Error:", xhr.responseText);
                    }
                }
            };
            xhr.open("GET", API_URL, true);
            xhr.setRequestHeader("X-Access-Token", API_KEY);
            xhr.send();
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.className = ''; // Zobrazit chybovou zprávu
        }

        // Funkce pro zobrazení odjezdů
        function displayDepartures(data) {
            departuresContainer.innerHTML = ''; 

            if (!data.departures || data.departures.length === 0) {
                 stopNameElement.textContent = "Zastávka: Kněžská luka";
                 departuresContainer.innerHTML = '<p style="text-align: center;">Pro tuto zastávku nebyly nalezeny žádné nadcházející odjezdy tramvají.</p>';
                 return;
            }
            
            if (data.stops && data.stops.length > 0) {
                stopNameElement.textContent = "Zastávka: " + data.stops[0].stop_name;
            }

            var now = new Date();
            lastRefreshedElement.textContent = "Aktualizováno: " + now.toLocaleTimeString('cs-CZ');

            var html = '';
            for (var i = 0; i < data.departures.length; i++) {
                var departure = data.departures[i];

                var departureTime = new Date(departure.departure_timestamp.predicted);
                var timeString = departureTime.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
                
                var delay = departure.delay.is_available ? departure.delay.minutes : null;
                var delayInfo = '';
                var delayColor = '#555'; // Šedá
                if (delay !== null) {
                    if (delay === 0) {
                        delayInfo = 'Na čas';
                        delayColor = '#02964f'; // Zelená
                    } else if (delay > 0) {
                        delayInfo = delay + ' min zpoždění';
                        delayColor = '#d00'; // Červená
                    } else { 
                         delayInfo = Math.abs(delay) + ' min náskok';
                         delayColor = '#009ee0'; // Modrá
                    }
                } else {
                    delayInfo = 'Info nedostupné';
                }
                
                var lineColor = '#3b82f6'; // Výchozí modrá
                var tramNumber = departure.route.short_name;
                if (tramNumber === '9') {
                    lineColor = '#009ee0';
                } else if (tramNumber === '11') {
                    lineColor = '#02964f';
                } else if (tramNumber === '31') {
                    lineColor = '#808080';
                }

                html +=
                    '<div class="tram-card">' +
                        '<div class="card-top">' +
                            '<div class="line-box"><span class="line-number" style="background-color: ' + lineColor + ';">' + tramNumber + '</span></div>' +
                            '<div class="destination">' + departure.trip.headsign + '</div>' +
                            '<div class="time">' + timeString + '</div>' +
                        '</div>' +
                        '<div class="card-bottom">' +
                            '<div class="delay" style="color: ' + delayColor + ';">' + delayInfo + '</div>' +
                            '<div class="platform">Nást.: ' + (departure.stop.platform_code || 'N/A') + '</div>' +
                            '<div class="clear"></div>' +
                        '</div>' +
                    '</div>';
            }
            departuresContainer.innerHTML = html;
        }

        // Spustit aplikaci
        fetchTramDepartures();
    </script>

</body>
</html>
